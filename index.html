<html>
    <head>
        <title>Planea Horario ITAM</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--Contiene declaraciones de clases que se usan-->
        <script src="js/classes.js"></script>
        <!--Contiene los datos de horarios y de MisProfes.com-->
        <script src="js/data.js"></script>
        <!--Contiene el javascript principal-->
        <script src="js/main.js"></script>
        <!--Contiene metodos para generar y controlar elementos de UI-->
        <script src="js/uiUtils.js"></script>
        <!--CSS-->
        <link rel="stylesheet" href="style.css">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-07PYLHL7M4"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-07PYLHL7M4');
        </script>
    </head>
    <body>
        <div id="header"></div> <!--Tira verde superior-->
        <center>
        <br><br>
        <table>
            <tr>
                <td style="vertical-align:top">
                    <center>
                    <h1>Planea tu Horario ITAM</h1>
                    Agrega tus clases y explora posibles horarios ordenados de acuerdo a tus preferencias
                    <br>
                        <a href="https://github.com/emiliocantuc/emiliocantuc.github.io">¿Cómo funciona?</a> |
                        <a href="profesores.html">Busca Profesores</a> |
                        <a href="mailto:sugerencias@horariositam.com">Sugerencias</a>
                    <br><br>
                    <small id="datosSemestre">(Datos PRIMAVERA 2022)</small>
                    <br><br>
                    <div id="main_form">
                        <form id="clases_form">
                            <input list="clases_datalist" placeholder="Buscar Clase" size="35" id="a" onfocus="this.value=''" autofocus>
                                <!--Datalist con la lista de clases-->
                                <datalist id="clases_datalist"></datalist>
                                <!--Boton de Agregar-->
                                <input type=button value="Agregar" id="agregar_button" onclick="agregar(document.getElementById('a').value)"/>
                                <!--Tabla y inputs de preferencias-->
                                <br>
                                <table border="0">
                                    <tr>
                                        <td><center><b>Preferencias</b></center></td>
                                        <td><center><b>Importancia</b></center></td>
                                    </tr>
                                    <!--Preferencia: MisProfes-->
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="mis_profes_score" id="mis_profes_box" onclick="document.getElementsByName('mis_profes_peso')[0].value=(this.checked?'50':'0');" checked>Rankear con <a target="_blank" href="https://www.misprofesores.com/escuelas/ITAM-Instituto-Tecnologico-Autonomo-de-Mexico_1003">MisProfes.com</a>
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="mis_profes_peso" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!--Preferencia: Clases Juntas o Separadas-->
                                    <br>
                                    <tr>
                                        <td>
                                            Clases: <input type="radio" name="juntas_separadas" id="juntas" checked/> Juntas
                                            <input type="radio" name="juntas_separadas" id="separadas"/> Separadas
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="juntas_peso" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!--Preferencia: Rango de Hoario-->
                                    <tr>
                                        <td>
                                            Rango de horario: <select name="start_rango" size="1"><option value="07:00" selected>7:00</option><option value="07:30">7:30</option><option value="08:00">8:00</option><option value="08:30">8:30</option><option value="09:00">9:00</option><option value="09:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option><option value="11:30">11:30</option><option value="12:00">12:00</option><option value="12:30">12:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option><option value="15:30">15:30</option><option value="16:00">16:00</option><option value="16:30">16:30</option><option value="17:00">17:00</option><option value="17:30">17:30</option><option value="18:00">18:00</option><option value="18:30">18:30</option><option value="19:00">19:00</option><option value="19:30">19:30</option><option value="20:00">20:00</option><option value="20:30">20:30</option><option value="21:00">21:00</option><option value="21:30">21:30</option></select>
                                            a <select name="end_rango" size="1"><option value="07:00">7:00</option><option value="07:30">7:30</option><option value="08:00">8:00</option><option value="08:30">8:30</option><option value="09:00">9:00</option><option value="09:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option><option value="11:30">11:30</option><option value="12:00">12:00</option><option value="12:30">12:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option><option value="14:00" selected>14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option><option value="15:30">15:30</option><option value="16:00">16:00</option><option value="16:30">16:30</option><option value="17:00">17:00</option><option value="17:30">17:30</option><option value="18:00">18:00</option><option value="18:30">18:30</option><option value="19:00">19:00</option><option value="19:30">19:30</option><option value="20:00">20:00</option><option value="20:30">20:30</option><option value="21:00">21:00</option><option value="21:30">21:30</option></select>
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="peso_rango" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!--Preferencia: Dia con menos clases-->
                                    <tr>
                                        <td>
                                            Día con menos clases: <select name="dia" size="1"><option value="LU">LU</option><option value="MA">MA</option><option value="MI">MI</option><option value="JU">JU</option><option value="VI" selected>VI</option><option value="SA">SA</option></select>
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="peso_dia" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!--Espacio?-->
                                    <tr><td><p></p></td></tr>
                                    <!--Opcion de generado-->
                                    <!--
                                    <tr>
                                        <td>
                                            <b>Generar: </b>
                                            <select name="metodoGeneracion" onchange="document.getElementById('sampleo_count').disabled=!document.getElementById('sampleo_count').disabled" size="1">
                                                <option value="sampleo">Sampleo</option>
                                                <option value="todos" selected>Todos (tardado)</option>
                                            </select>
                                        </td>
                                        <td>
                                            <center>
                                            <input type="number" width="10" min="1" id="sampleo_count" max="1000000" value="1000" disabled/>
                                            </center>
                                        </td>
                                    </tr>
                                     -->
                                </table>
                                <!--Boton de Generar-->
                                <br><input type=button value="Generar" id="botonGenerar" onclick="generar()"/>
                            </input>
                        </form>
                    </div>
                    <div id="content">
                    <center>
                        <center>
                        <table border=0 style="padding:0px;"><tr style="padding:0px"><td style="padding:0px">
                        </center>
                            <div id='clases_actuales' style="padding:0px;">
                                <ul id='clases_en_horario' style="padding:0px"></ul>
                            </div>
                        </td></tr></table>
                    </div>
                </td>
                <td id="space"></td> <!--Espacio entre menu principal y la columna "Resultados" (en escritorio)-->
                <td style="vertical-align:top">
                    <div id="resultados"></div>
                </td>
            </tr>
            <tr>
                <td>
                    <center><div id="resultados_mobile"></div></center>
                </td>
            </tr>
        </table>
        <div id="para_imprimir" style="display:none"></div> <!--TODO Se usa?-->
        <!--Forma para "Ver en Horarios ITAM"-->
        <!--TODO cargar valores dinamicamente desde js e incluir s= en datos.js -->
        <form name="detalles" style="" target="_blank" action="https://serviciosweb.itam.mx/EDSUP/BWZKSENP.P_Horarios2" method="post">
          <input type="hidden" name="s" value="1995"><br>
          <input type="hidden" value="" name="txt_materia"><br>
        </form>

        <script>
            //Cargar constantes ubicadas en data.js
            //"Datos [Semestre] [Año]"
            document.getElementById("datosSemestre").innerHTML='(Datos '+periodo+')';
            //Valores para links a grace
            document.getElementsByName("detalles")[0].action=formPostUrl;
            document.getElementsByName("s")[0].value=sGrace;
            //Llenamos datalist de "Buscar Clase"
            llenaDatalist();

            //Variables globales para navegacion
            let clasesSeleccionadas={};
            let mobile=window.innerWidth <= 800;
            let horariosGenerados=NaN;
            let horariosFavoritos=[];
            let resultado=0; //el horarioGenerado desplegado actualmente 
            cargaDeCookies(); //TODO checa si tienen que aceptar cookies legalmente

            //Regresa clasesSeleccionadas pero solo con grupos seleccionados
            function clasesSeleccionadasFiltradas(clasesSeleccionadas,preferencias){
                let clasesSeleccionadasCopy={...clasesSeleccionadas}; //copia local
                let out={}; //ClaveClase: Clase() con grupos filtrados
                for(let claveClase in preferencias.gruposSeleccionados){
                    let numerosGrupos=preferencias.gruposSeleccionados[claveClase];
                    let grupos={};
                    for(let numeroGrupo of numerosGrupos)
                        grupos[numeroGrupo]=clasesSeleccionadasCopy[claveClase].grupos[numeroGrupo];
                    
                    out[claveClase]=clasesSeleccionadasCopy[claveClase];
                    out[claveClase].grupos=grupos;
                }
                return out;
            }
            //Cuando se oprime el boton de Generar
            function generar(){
                let preferencias=getPreferencias();
                let conGruposFiltrados=clasesSeleccionadasFiltradas(clasesSeleccionadas,preferencias);
                //Chequeos entradas
                if(Object.keys(conGruposFiltrados).length==0){
                    alert("Agrega tus clases para generar tus horarios");
                    return;
                }
                if(preferencias.nGruposSeleccionados==0){
                    alert("Selecciona por lo menos un grupo de tus clases para generar tus horarios");
                    return;
                }
                //Guarda Cookies
                let nombresClasesSeleccionadas=[];
                for(let clase of Object.values(conGruposFiltrados))
                    nombresClasesSeleccionadas.push(clase.nombre);
                setCookie("clasesSeleccionadas",nombresClasesSeleccionadas.join("*"),30);
                //Generacion
                let horarios=NaN;
                if(preferencias.generacion=="todos"){
                    console.log("Generando todos");
                    horarios=generarTodosHorarios(conGruposFiltrados,preferencias);
                    if(horarios.length==0){
                        alert("Imposible generar horarios con los grupos ingresados.");
                        return;
                    }
                    horariosGenerados=horarios;
                }else{
                    //horarios=sampleo();
                }
                //Mostramos
                if(!mobile){
                    document.getElementById("space").style="width:60px;";
                    document.getElementById("resultados").innerHTML=resultadosHTML(horarios[0],horarios.length,mobile);
                }else{
                    //document.getElementById("resultados_mobile").innerHTML=resultadosHTML(horarios[0],horarios.length,mobile)+"<p>mobile detected - site designed for desktop</p>";
                    //Saltar a resultados
                    document.getElementById("resultados").scrollIntoView(true); 
                }
                actualizaBotonGuardar();
            }

        </script>
    </body>
</html>
