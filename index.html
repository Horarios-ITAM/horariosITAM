<html>
    <head>
        <title>Planea Tu Horario ITAM</title>
        <meta name="description" content="Encuentra los mejores horarios de acuerdo a tus preferencias y busca qué clases darán tus profesores favoritos.">
        <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

        <!-- Facebook Meta Tags -->
        <meta property="og:url" content="https://horariositam.com/">
        <meta property="og:type" content="website">
        <meta property="og:title" content="Planea Tu Horario Del ITAM">
        <meta property="og:description" content="Encuentra los mejores horarios de acuerdo a tus preferencias y busca qué clases darán tus profesores favoritos.">
        <meta property="og:image" content="https://horariositam.com/assets/img/preview.png">

        <!-- Twitter Meta Tags -->
        <meta name="twitter:card" content="summary_large_image">
        <meta property="twitter:domain" content="horariositam.com">
        <meta property="twitter:url" content="https://horariositam.com/">
        <meta name="twitter:title" content="Planea Tu Horario Del ITAM">
        <meta name="twitter:description" content="Encuentra los mejores horarios de acuerdo a tus preferencias y busca qué clases darán tus profesores favoritos.">
        <meta name="twitter:image" content="https://horariositam.com/assets/img/preview.png">

        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="assets/img/icon.ico">

        <!-- Contiene declaraciones de clases que se usan -->
        <script src="js/classes.js"></script>
        <!-- Contiene los datos de horarios y de MisProfes.com -->
        <script src="js/datos/datos_index.js"></script>
        <!-- Contiene el javascript principal -->
        <script src="js/main.js"></script>
        <!-- Contiene metodos para generar y controlar elementos de UI -->
        <script src="js/uiUtils.js"></script>
        <!-- CSS -->
        <link rel="stylesheet" href="style.css">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-07PYLHL7M4"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-07PYLHL7M4');
        </script>
    </head>
    <body>
        <!-- Tira verde superior -->
        <div id="header"></div>
        <center>
        <br><br>
        <table>
            <tr>
                <td style="vertical-align:top">
                    <center>
                    <h1>Planea tu Horario ITAM</h1>
                    Agrega tus clases y explora posibles horarios ordenados de acuerdo a tus preferencias
                    <br>
                        <a href="comoSeUsa.html">¿Cómo se usa?</a> |
                        <a href="profesores.html">Busca Profesores</a> |
                        <a href="calendarios.html">Calendarios</a> |
                        <a href="mailto:sugerencias@horariositam.com">Sugerencias</a>
                    <br><br>
                    <small id="datosSemestre">Datos PRIMAVERA 2022</small>
                    <br>
                    <small id="actualizadoHace">Actualizado hace ...</small>
                    <br><br>
                    <div id="main_form">
                        <form id="clases_form">
                            <input list="clases_datalist" placeholder="Buscar Clase" size="35" id="a" onfocus="this.value=''" autofocus>
                                <!-- Datalist con la lista de clases -->
                                <datalist id="clases_datalist"></datalist>
                                <!-- Boton de Agregar -->
                                <input type=button value="Agregar" id="agregar_button" class="custom-button" onclick="agregar(document.getElementById('a').value)"/>
                                <!-- Tabla y inputs de preferencias -->
                                <br>
                                <table border="0">
                                    <tr>
                                        <td><center><b>Preferencias</b></center></td>
                                        <td><center><b>Importancia</b></center></td>
                                    </tr>
                                    <!-- Preferencia: MisProfes -->
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="mis_profes_score" id="mis_profes_box" onclick="document.getElementsByName('mis_profes_peso')[0].value=(this.checked?'50':'0');" checked>Rankear con <a target="_blank" href="https://www.misprofesores.com/escuelas/ITAM-Instituto-Tecnologico-Autonomo-de-Mexico_1003">MisProfes.com</a>
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="mis_profes_peso" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!-- Preferencia: Clases Juntas o Separadas -->
                                    <br>
                                    <tr>
                                        <td>
                                            Clases: <input type="radio" name="juntas_separadas" id="juntas" checked/> Juntas
                                            <input type="radio" name="juntas_separadas" id="separadas"/> Separadas
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="juntas_peso" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!-- Preferencia: Rango de Hoario -->
                                    <tr>
                                        <td>
                                            Rango de horario: <select name="start_rango" size="1"><option value="07:00">7:00</option><option value="07:30">7:30</option><option value="08:00">8:00</option><option value="08:30">8:30</option><option value="09:00" selected>9:00</option><option value="09:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option><option value="11:30">11:30</option><option value="12:00">12:00</option><option value="12:30">12:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option><option value="14:00">14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option><option value="15:30">15:30</option><option value="16:00">16:00</option><option value="16:30">16:30</option><option value="17:00">17:00</option><option value="17:30">17:30</option><option value="18:00">18:00</option><option value="18:30">18:30</option><option value="19:00">19:00</option><option value="19:30">19:30</option><option value="20:00">20:00</option><option value="20:30">20:30</option><option value="21:00">21:00</option><option value="21:30">21:30</option></select>
                                            a <select name="end_rango" size="1"><option value="07:00">7:00</option><option value="07:30">7:30</option><option value="08:00">8:00</option><option value="08:30">8:30</option><option value="09:00">9:00</option><option value="09:30">9:30</option><option value="10:00">10:00</option><option value="10:30">10:30</option><option value="11:00">11:00</option><option value="11:30">11:30</option><option value="12:00">12:00</option><option value="12:30">12:30</option><option value="13:00">13:00</option><option value="13:30">13:30</option><option value="14:00" selected>14:00</option><option value="14:30">14:30</option><option value="15:00">15:00</option><option value="15:30">15:30</option><option value="16:00">16:00</option><option value="16:30">16:30</option><option value="17:00">17:00</option><option value="17:30">17:30</option><option value="18:00">18:00</option><option value="18:30">18:30</option><option value="19:00">19:00</option><option value="19:30">19:30</option><option value="20:00">20:00</option><option value="20:30">20:30</option><option value="21:00">21:00</option><option value="21:30">21:30</option></select>
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="peso_rango" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!-- Preferencia: Dia con menos clases -->
                                    <tr>
                                        <td>
                                            Día con menos clases: <select name="dia" size="1"><option value="LU">LU</option><option value="MA">MA</option><option value="MI">MI</option><option value="JU">JU</option><option value="VI" selected>VI</option><option value="SA">SA</option></select>
                                        </td>
                                        <td>
                                            <input type="range" class="slider" name="peso_dia" min="0" max="100">
                                        </td>
                                    </tr>
                                    <!-- Preferencia: Mismo grupo teoria y lab -->
                                    <tr>
                                        
                                        <td>
                                            <input type="checkbox" name="mismo_grupo_teoria_lab" id="mismo_grupo_box" checked>Mismo grupo teoría y lab (ingenierías)    </input>
                                        </td>
                                    </tr>
                                </table>
                                <!-- Boton de Generar -->
                                <br><input type=button class="custom-button" value="Generar" id="botonGenerar" onclick="generar()"/>
                            </input>
                        </form>
                    </div>
                    <div id="content">
                    <center>
                        <center>
                        <table border=0 style="padding:0px;">
                            <!-- Opciones guardadas -->
                            <tr style="padding:0px">
                                <td style="padding:0px">
                                    </center>
                                    <div id='favoritos' style="padding:0px;"></div>
                                </td>
                            </tr>
                            <!-- Clases seleccionadas -->
                            <tr style="padding:0px">
                                <td style="padding:0px">
                                    </center>
                                    <div id='clases_actuales' style="padding:0px;">
                                        <ul id='clases_en_horario' style="padding:0px"></ul>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </td>
                <!-- Espacio entre menu principal y la columna "Resultados" (en escritorio) -->
                <td id="space"></td> 
                <td style="vertical-align:top">
                    <div id="resultados"></div>
                </td>
            </tr>
            <tr>
                <td>
                    <!-- Espacio entre menu principal y la columna "Resultados" (en movil) -->
                    <center><div id="resultados_mobile"></div></center>
                </td>
            </tr>
        </table>
        <div id="para_imprimir" style="display:none"></div>

        <!-- Forma para "Ver en Horarios ITAM" si se scrapearon de Servicios No Personalizados -->
        <form name="detalles" style="" target="_blank" action="https://serviciosweb.itam.mx/EDSUP/BWZKSENP.P_Horarios2" method="post">
          <input type="hidden" name="s" value="1995"><br>
          <input type="hidden" value="" name="txt_materia"><br>
        </form>

        <!-- Forma para "Ver en Horarios ITAM" si se scrapearon de Secure Area -->
        <form name="detalles-secure" target="_blank" action="https://serviciosweb.itam.mx/EDSUP/bwskfcls.P_GetCrse" method="post">
            <input type="hidden" name="term_in" value="202301" >
            <INPUT TYPE="hidden" NAME="sel_subj" VALUE="dummy">
            <input type="hidden" name="sel_subj" value="ADM" >
            <input type="hidden" name="SEL_CRSE" value="11002" >
            <input type="hidden" name="SEL_TITLE" value="">
            <input type="hidden" name="BEGIN_HH" value="0">
            <input type="hidden" name="BEGIN_MI" value="0">
            <input type="hidden" name="BEGIN_AP" value="a">
            <input type="hidden" name="SEL_DAY" value="dummy">
            <input type="hidden" name="SEL_PTRM" value="dummy">
            <input type="hidden" name="END_HH" value="0">
            <input type="hidden" name="END_MI" value="0">
            <input type="hidden" name="END_AP" value="a">
            <input type="hidden" name="SEL_CAMP" value="dummy">
            <input type="hidden" name="SEL_SCHD" value="dummy">
            <input type="hidden" name="SEL_SESS" value="dummy">
            <input type="hidden" name="SEL_INSTR" value="dummy">
            <input type="hidden" name="SEL_INSTR" value="%">
            <input type="hidden" name="SEL_ATTR" value="dummy">
            <input type="hidden" name="SEL_ATTR" value="%">
            <input type="hidden" name="SEL_LEVL" value="dummy">
            <input type="hidden" name="SEL_LEVL" value="%">
            <input type="hidden" name="SEL_INSM"  value="dummy">
            <input type="hidden" name="sel_dunt_code"  value="">
            <input type="hidden" name="sel_dunt_unit"  value="">
            <input type="hidden" name="call_value_in"  value="">
            <input type="hidden" name="rsts" value="dummy" />
            <input type="hidden" name="crn" value="dummy" />
            <input type="hidden" name="path" value="1" >
            <INPUT TYPE="hidden" NAME="SUB_BTN" VALUE="View Sections" >
        </form>


        <script>
            // Cargar constantes ubicadas en data.js
            // "Datos [Semestre] [Año]"
            document.getElementById("datosSemestre").innerHTML='Datos '+periodo;
            document.getElementById("actualizadoHace").innerHTML='Actualizados hace '+timeSince(new Date(parseInt(actualizado)));
            
            // Rellenamos las formas para "Ver en Horarios ITAM"
            if(secure){
                document.getElementsByName("detalles-secure")[0].action=formPostUrl;
                document.getElementsByName("SEL_CRSE")[0].value=sGrace;
                
            }else{         
                document.getElementsByName("detalles")[0].action=formPostUrl;
                document.getElementsByName("s")[0].value=sGrace;
            }


            // Llenamos datalist de "Buscar Clase"
            llenaDatalist();

            // Variables globales para navegacion
            let clasesSeleccionadas={};             // Map<Clave materia -> Clase (obj)> para las clases seleccionadas 
            let mobile=window.innerWidth <= 800;    // (Boolean) si la pantalla corresponde a movil
            let horariosGenerados=[];               // Ultimos horarios generados
            let horariosFavoritos=[];               // Horarios en "Opciones Guardadas"
            let resultado=0;                        // El indice del horarioGenerado desplegado actualmente 

            // Cargamos datos guardados en cookies si existen
            if((getCookie("favoritos").length>0 || getCookie("clasesSeleccionadas").length>0) && confirm("Usar información guardada?")){
                cargaCookieClassesSeleccionadas(); // TODO checa si tienen que aceptar cookies legalmente
                cargaCookieHorariosFavoritos();
                cargaCookiePreferencias();
            }
            // Si se cargaron cookies actualizamos el UI
            if(horariosGenerados.length>0){
                mostrar();
                actualizarResultado(0);
            }

            /**
             * Regresa clasesSeleccionadas pero solo con grupos seleccionados
             * 
             * @param {Map<String,Clase>} clasesSeleccionadas Las clases seleccionadas por el usuario
             * @param {Preferencias} preferencias Obj. de Preferencias correspondiente al usuario.
             * @returns {Map<String,Clase>} 
             */
            function clasesSeleccionadasFiltradas(clasesSeleccionadas,preferencias){
                // Hacemos una copia local
                let clasesSeleccionadasCopy={...clasesSeleccionadas};
                // La version a regresar
                let out={};
                for(let claveClase in preferencias.gruposSeleccionados){
                    let numerosGrupos=preferencias.gruposSeleccionados[claveClase];
                    let grupos={};
                    for(let numeroGrupo of numerosGrupos)
                        grupos[numeroGrupo]=clasesSeleccionadasCopy[claveClase].grupos[numeroGrupo];
                    
                    out[claveClase]=clasesSeleccionadasCopy[claveClase];
                    out[claveClase].grupos=grupos;
                }
                return out;
            }

            /**
             * Callback para el boton de Generar
            */
            function generar(){
                // Conseguimos las preferencias y los grupos seleccionados
                let preferencias=getPreferencias();
                let conGruposFiltrados=clasesSeleccionadasFiltradas(clasesSeleccionadas,preferencias);

                // Checamos que tengamos por lo menos un grupo seleccionado
                if(Object.keys(conGruposFiltrados).length==0){
                    alert("Agrega tus clases para generar tus horarios");
                    return;
                }
                if(preferencias.nGruposSeleccionados==0){
                    alert("Selecciona por lo menos un grupo de tus clases para generar tus horarios");
                    return;
                }

                // Guardamos cookie de clasesSeleccionadas
                let nombresClasesSeleccionadas=[];
                for(let clase of Object.values(conGruposFiltrados))
                    nombresClasesSeleccionadas.push(clase.nombre);

                // Se guardan los nombres de las clases separadas por *, por 30 dias
                setCookie("clasesSeleccionadas",nombresClasesSeleccionadas.join("*"),30);
                setCookie("preferencias",JSON.stringify(preferencias),30);

                // Generacion
                let horarios=[];
                if(preferencias.generacion=="todos"){
                    console.log("Generando todos");
                    horarios=generarTodosHorarios(conGruposFiltrados,preferencias);
                    if(horarios.length==0){
                        alert("Imposible generar horarios con los grupos ingresados.");
                        return;
                    }
                    // Incluimos horarios favoritos antes que los recien generados
                    horariosGenerados=[];
                    horariosGenerados.push(...horariosFavoritos);
                    horariosGenerados.push(...horarios);
                }else{
                    // Para otros posibles metodos de generacion (i.e sampleo, etc.)
                    //horarios=sampleo();
                }
                // Mostramos
                mostrar();
                actualizarResultado(horariosFavoritos.length);  
            }

            /**
             * Muestra la tabla de resultados
            */
            function mostrar(){
                // Si hay opciones guardadas recorremos el indice para mostrar los recien generados
                let index=(horariosFavoritos.length>0 && horariosGenerados.length>horariosFavoritos.length)?horariosFavoritos.length:0;
                if(!mobile){
                    document.getElementById("space").style="width:60px;";
                    document.getElementById("resultados").innerHTML=resultadosHTML(horariosGenerados[index],horariosGenerados.length,mobile);
                }else{
                    document.getElementById("resultados_mobile").innerHTML=resultadosHTML(horariosGenerados[index],horariosGenerados.length,mobile);
                    // Saltar a resultados
                    scrollToResultados();
                }
                actualizaBotonGuardar();
            }

            /**
             * Enfoca la tabla de resultados para movil
            */ 
            function scrollToResultados(){
                document.getElementById("resultados_mobile").scrollIntoView(true);
            }

        </script>
    </body>
</html>
